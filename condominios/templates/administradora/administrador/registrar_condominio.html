# -*- coding: utf-8 -*-
{% extends "base.html" %}
{% load static %}
{% block contenido %}

<script type="text/javascript">
  function set_multiselect()
{
    alert(55);
    var multiselect = $('.multiselect');

    $(multiselect).find('select').each(function(){
        $(this).append(
            $('<option>')
            .val('0')
            .text($(this).attr('title'))
            .addClass('label')
        )
        .addClass('disabled')
        .prop('disabled', true)
    });

    get_geo(
        $(multiselect).find('select').first(),
        [$(multiselect).find('select').first().attr('data-query')]
    );

    $(multiselect).find('select').each(function(){

        $(this).on('change', function(){

            if(!$(this).val() || !$(this).next().is('select'))
                return false;

            var parent_val = false,
                query_val;

            if(typeof $(this).attr('data-parent') !== 'undefined')
                parent_val = $(multiselect).find('select[name=' + $(this).next().attr('data-parent') + ']').val();

            query_val  = parent_val || $(this).val();

            if(parseInt(query_val) === 0)
                return false;

            if($(this).children().length > 1)
            {
                var current = $(this);

                do
                {
                    current = $(current).next();
                    $(current).find('option:not(.label)').remove();
                }
                while(!$(current).is(':last-child'));
            }

            get_geo($(this).next(), [
                $(this).next().attr('data-query'),
                query_val
            ]);
        });
    });
}

var geo_cache = [];

function get_geo(dropdown, query)
{
    var fill_dropdown = function(data){

            for(var x in data)
            {
                $(dropdown).append(
                    $('<option>')
                    .val(data[x].id)
                    .text(data[x][$(dropdown).attr('name')])
                )
            }

            $(dropdown).prop('disabled', false).removeClass('disabled');
        };

    if(!geo_cache[query.join('.')])
        geo_cache[query.join('.')] = [];
    else
        return fill_dropdown(geo_cache[query.join('.')]);

    $(dropdown).addClass('loading');

    $.ajax({
        dataType : 'json',
        type : 'GET',
        url  : '/geo/' + query.join('/'),
        success : function(h) {

            fill_dropdown(h.data);
            geo_cache[query.join('.')] = h.data;

        },
        error : function(h) {

            if(h.error == 'empty')
            {
                $(dropdown).find('option:not(.label)').remove();
            }

        },
        complete : function()
        {
            $(dropdown).removeClass('loading');
        }
    });

}

$(document).ready(set_multiselect);
</script>


<div class="page">
  <div class="page-content">
{% include "mensajes_boostrap.html" %} 
      <div class="page-content vertical-align-middle">
      <div class="brand">
         {{ prueba }}
        <h2 class="brand-text">Registrar condominio</h2>
      </div>
      <form method="POST" role="form">{% csrf_token %}
		
        <div class="form-group">
          {{ form.condominio }}
          {{ form.condominio.errors }}
        </div>
        <div class="form-group">
          {{ form.rif }}
          {{ form.rif.errors }}
        </div>
        <div class="form-group">
          {{ form.telefono }}
          {{ form.telefono.errors }}
        </div>
        <div class="form-group">
          {{ form.correo }}
          {{ form.correo.errors }}
        </div>
        <div class="form-group">
          {{ form.parroquia }}
          {{ form.parroquia.errors }}
        </div>
        <div class="form-group">
          {{ form.ciudad }}
          {{ form.ciudad.errors }}
        </div>
        <div class="form-group">
          {{ form.avenidaCalle }}
          {{ form.avenidaCalle.errors }}
        </div>
        <div class="form-group">
          {{ form.urbanizacionSector }}
          {{ form.urbanizacionSector.errors }}
        </div>
        <div class="form-group">
          {{ form.tipoEdificacion }}
          {{ form.tipoEdificacion.errors }}
        </div>
        <div class="form-group">
          {{ form.nombreEdificacion }}
          {{ form.nombreEdificacion.errors }}
        </div>          
        <button type="submit" class="btn btn-primary btn-block">Guardar condominio</button>
      </form>
      <div class="form-group clearfix">          
          <!--<a class="pull-center" href="javascript:history.back();">Volver</a> -->
          <button type="button" class="btn btn-info btn-block" onclick="history.back();">Volver</button>
      </div>
    </div>
{{ form.errors }}

    <div class="multiselect">
    <select name="estado" data-query="estados" title="Estado"></select>
    <select name="ciudad" data-query="ciudades" data-parent="estado" title="Ciudad"></select>
    <select name="municipio" data-query="municipios" data-parent="estado" title="Municipio"></select>
    <select name="parroquia" data-query="parroquias" data-parent="municipio" title="Parroquia"></select>
</div>
</div>
</div>



{% endblock contenido %}
